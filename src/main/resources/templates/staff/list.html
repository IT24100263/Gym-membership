<!DOCTYPE html>
<html lang="en" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin - Payment Records</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS Includes -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
     <style>
         .action-buttons form { display: inline-block; margin: 0; }
         .status-badge { min-width: 90px; text-align: center; font-weight: 500; padding: 0.4em 0.6em; }
         .time-col { min-width: 160px; }
     </style>
</head>
<body>
    <!-- Navbar -->
     <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top border-bottom shadow-sm">
        <!-- ... Include consistent Navbar code ... -->
        <div class="container">... Navbar content ...</div>
     </nav>

<div class="container mt-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-receipt me-2"></i>Payment Records Management</h1>
         <a th:href="@{/staff/dashboard}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
         </a>
    </div>

    <!-- Flash Messages -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">...</div>
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">...</div>
     <div th:if="${filterError}" class="alert alert-warning py-1 mt-2" role="alert" th:text="${filterError}">Warning</div>

    <!-- Filter Form -->
    <form th:action="@{/staff/payments}" method="get" class="filter-form row g-3 align-items-center bg-light p-3 rounded border mb-3 shadow-sm">
         <div class="col-auto"><label for="statusFilter" class="col-form-label fw-semibold">Filter by Status:</label></div>
         <div class="col-md-3 col-sm-4">
            <select class="form-select form-select-sm" id="statusFilter" name="statusFilter">
                <option value="">-- All Statuses --</option>
                <option th:each="s : ${statuses}" th:value="${s.name()}" th:text="${s.name()}" th:selected="${s.name() == currentFilter}">STATUS</option>
            </select>
         </div>
         <div class="col-auto"><button type="submit" class="btn btn-secondary btn-sm">Filter</button></div>
         <div class="col-auto" th:if="${currentFilter != null && !currentFilter.isEmpty()}"><a th:href="@{/staff/payments}" class="btn btn-outline-secondary btn-sm">Clear Filter</a></div>
    </form>

    <div class="card shadow-sm">
        <div class="card-body">
             <h5 class="card-title mb-3">Payment Log</h5>
             <div class="table-responsive">
                <table class="table table-hover table-striped align-middle caption-top">
                    <caption>List of member payment records</caption>
                    <thead class="table-light">
                        <tr>
                            <th>Payment ID</th>
                            <th>Member ID</th>
                            <th>Plan ID</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Payment Date</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="rec : ${payments}">
                            <td th:text="${rec.paymentId}">PAY001</td>
                            <td><a th:href="@{/members/profile/{id}(id=${rec.memberId})}" th:text="${rec.memberId}" title="View Member">M001</a></td>
                            <td th:text="${rec.membershipPlanId}">P001</td>
                            <td th:text="${'$'+#numbers.formatDecimal(rec.amount, 1, 2)}">$0.00</td>
                            <td th:text="${rec.dueDate != null ? #temporals.format(rec.dueDate, 'yyyy-MM-dd') : '-'}"></td>
                            <td class="time-col" th:text="${rec.paymentTimestamp != null ? #temporals.format(rec.paymentTimestamp, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                            <td class="text-center">
                                <span th:switch="${rec.status.name()}" class="badge status-badge"
                                      th:classappend="${rec.status.name() == 'PAID' ? 'bg-success' : (rec.status.name() == 'PENDING' ? 'bg-warning text-dark' : (rec.status.name() == 'OVERDUE' or rec.status.name() == 'FAILED' ? 'bg-danger' : 'bg-secondary'))}"
                                      th:text="${rec.status.name()}">STATUS</span>
                            </td>
                            <td class="text-center action-buttons">
                                 <!-- Show "Mark as Paid" button only if status is not already PAID -->
                                 <form th:if="${rec.status.name() != 'PAID'}" th:action="@{/staff/payments/mark-paid/{id}(id=${rec.paymentId})}" method="post">
                                     <button type="submit" class="btn btn-sm btn-outline-success" title="Mark as Paid">
                                         <i class="fas fa-check-circle"></i> Mark Paid
                                     </button>
                                 </form>
                                 <span th:unless="${rec.status.name() != 'PAID'}" class="text-muted fst-italic small">N/A</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(payments)}">
                            <td colspan="8" class="text-center text-muted p-3">No payment records found matching the criteria.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
 <footer class="py-3 mt-4">...</footer>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script> /* Theme JS */ (() => { /*...*/ })(); </script>
</body>
</html>